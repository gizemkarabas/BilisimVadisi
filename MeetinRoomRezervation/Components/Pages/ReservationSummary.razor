@page "/user/reservation-summary"
@using MeetinRoomRezervation.Models
@using MeetinRoomRezervation.Services.ReservationService
@using AntDesign
@using System.Globalization
@inject ReservationDto ReservationState
@inject IReservationService ReservationService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<div class="reservation-panel">
<div class="reservation-header">Rezervasyonunuzu Onaylayın</div>
<div class="reservation-card-center">
    @if (ReservationState.SelectedSlots.Any())
    {
        <div class="reservation-card">
            <div class="slots-list" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content:center;">
                @foreach (var slot in ReservationState.SelectedSlots)
                {
                    <div
                        style="background-color: #1890ff; color: white; padding: 8px 16px; border-radius: 5px; min-width: 100px; text-align: center;">
                        @slot.StartTime.ToString("HH:mm") - @slot.EndTime.ToString("HH:mm")
                    </div>
                }
            </div>
            <div style="text-align:center; margin-top: 10px;">
                <Descriptions Column="1">
                    <dl class="descriptions">
                        <dt>📍 Konum</dt>
                        <dd>@ReservationState.Location</dd>

                    <dt>🏢 Bölge</dt>
                    <dd>@ReservationState.Room.Name</dd>

                        <dt>📅 Tarih</dt>
                        <dd>@ReservationState.SelectedDate.ToString("dd.MM.yyyy dddd", turkishCulture)</dd>
                    </dl>
                </Descriptions>
            </div>

            <h4 style="text-align:center; margin-top:20px;">Toplam @ReservationState.SelectedSlots.Count Saatlik
                Seçim</h4>

            <div style="margin-top: 20px; text-align:center;">
                <Button Type="ButtonType.Primary" OnClick="ConfirmReservation" Style="width: 200px;">Onayla</Button>
            </div>

            <div style="margin-top: 10px; text-align:center;">
                <Button Type="ButtonType.Default" OnClick="GoBack" Style="width: 200px;">Geri</Button>
            </div>
        </div>
    }
    else
    {
        <Alert Message="Seçili saat bulunamadı." Type="@AlertType.Warning" ShowIcon="true"/>
    }
</div>
</div>

@code {
    private static readonly CultureInfo turkishCulture = new CultureInfo("tr-TR");

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"ReservationSummary - SelectedSlots count: {ReservationState?.SelectedSlots?.Count ?? 0}");

        if (ReservationState?.SelectedSlots != null)
        {
            foreach (var slot in ReservationState.SelectedSlots)
            {
                Console.WriteLine($"Summary slot: {slot.StartTime:HH:mm} - {slot.EndTime:HH:mm}");
            }
        }
    }

    private async Task ConfirmReservation()
    {
        try
        {
            Console.WriteLine($"ConfirmReservation - SelectedSlots count: {ReservationState?.SelectedSlots?.Count ?? 0}");

            if (ReservationState?.SelectedSlots == null || !ReservationState.SelectedSlots.Any())
            {
                Console.WriteLine("No slots to reserve!");
                return;
            }

            var result = await ReservationService.AddReservationAsync(ReservationState);

            if (!string.IsNullOrEmpty(result))
            {
                Navigation.NavigateTo("/user/myreservations");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error confirming reservation: {ex.Message}");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/user/reservationForm");
    }

}
