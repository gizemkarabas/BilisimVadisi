@page "/forgot-password"
@inject IPasswordResetService PasswordResetService
@inject NavigationManager Navigation

<div class="container" style="max-width: 70vw; margin: 0 auto; padding: 24px; margin-top:60px;">
    
    <div class="container-items">
        <Card>
            <Button Type="@ButtonType.Link"
                    OnClick="@(() => Navigation.NavigateTo("/login"))" 
                    Style="display: flex; justify-content: flex-start; color:crimson; font-size:12px;padding: 0; margin: 0;"
                    Block>
                &lt; Giriş Sayfasına Dön
            </Button>
            <div class="head-title">Şifrenizi mi Unuttunuz ?</div>
            <div class="head-note-title">Şifrenizi kurtarmak için aşağıya telefon numaranızı girin</div>

        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <Alert Message="@SuccessMessage" Type="@AlertType.Success" ShowIcon="true" Style="margin-bottom: 16px;" />
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <Alert Message="@ErrorMessage" Type="@AlertType.Error" ShowIcon="true" Style="margin-bottom: 16px;" />
        }

        @if (!isEmailSent)
        {
            <Form Model="@ForgotPasswordModel" OnFinish="HandleForgotPassword" Layout="@FormLayout.Vertical">
                <FormItem>
                    <div style="font-size:12px">E-posta Adresiniz</div>
                    <Input @bind-Value="@ForgotPasswordModel.Email"
                    Placeholder="Kayıtlı e-posta adresinizi giriniz"/>
                </FormItem>

                <FormItem>
                        <Button Type="@ButtonType.Primary"
                                Style="background-color: #515def;
                                color: #fff;
                                margin-top: 10px;
                                font-size: 10px;
                                font-weight: bold " Block>
                        Gönder
                    </Button>
                </FormItem>
            </Form>
        }
        else
        {
            <div style="text-align: center;">
                <Icon Type="mail" Style="font-size: 48px; color: #52c41a; margin-bottom: 16px;" />
                <p>E-posta adresinize şifre sıfırlama linki gönderildi.</p>
                <p>Lütfen e-posta kutunuzu kontrol ediniz.</p>
                <Button Type="@ButtonType.Primary" OnClick="@(() => Navigation.NavigateTo("/login"))">
                    Giriş Sayfasına Dön
                </Button>
            </div>
        }
    </Card>
    </div>
    <div class="image">
        <Image width={200}
               src="/Forgot-Password.png"
               alt="Travelwise Logo"
               Preview="false" />
    </div>
</div>

@code {
    private ForgotPasswordInputModel ForgotPasswordModel = new();
    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private bool isLoading = false;
    private bool isEmailSent = false;

    private async Task HandleForgotPassword()
    {
        if (string.IsNullOrWhiteSpace(ForgotPasswordModel.Email))
        {
            ErrorMessage = "E-posta adresi zorunludur.";
            return;
        }

        isLoading = true;
        ErrorMessage = "";
        SuccessMessage = "";

        try
        {
            var result = await PasswordResetService.SendPasswordResetEmailAsync(ForgotPasswordModel.Email);

            if (result)
            {
                isEmailSent = true;
                SuccessMessage = "Şifre sıfırlama linki e-posta adresinize gönderildi.";
            }
            else
            {
                ErrorMessage = "Bu e-posta adresi ile kayıtlı kullanıcı bulunamadı.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Bir hata oluştu. Lütfen tekrar deneyiniz.";
            Console.Error.WriteLine($"Forgot password error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    public class ForgotPasswordInputModel
    {
        public string Email { get; set; }
    }
}
